name: traefik
summary: Traefik ROCK
description: Traefik ROCK
license: Apache-2.0

version: "2.8.1"
base: ubuntu:20.04

entrypoint: ["/usr/bin/traefik"]

parts:
  pebble:
    plugin: go
    source: https://github.com/canonical/pebble.git
    source-commit: "32ead042e94714625a138e61f7223c68cd6326f4"
    build-snaps:
      - go/1.17/stable
    # Override until this issue is fixed: https://github.com/canonical/rockcraft/issues/21
    organize:
      bin/pebble: usr/bin/pebble
    stage:
      - usr/bin/pebble

  traefik:
    plugin: dump
    source: https://github.com/traefik/traefik/releases/download/v2.8.1/traefik_v2.8.1_linux_amd64.tar.gz
    source-checksum: sha256/f3547b9579c102d82542e85261056be2a31b0b8f14b1a3852073b707c0ee1153
    organize:
      traefik: usr/bin/traefik
    stage:
      - usr/bin/traefik

  default-config:
    plugin: dump
    source: files
    organize:
      traefik.yaml: etc/traefik/traefik.yaml
      001-default.yaml: var/lib/pebble/default/layers/001-default.yaml
    stage:
      - etc/traefik/traefik.yaml
      - var/lib/pebble/default/layers/001-default.yaml
    override-prime: |
      craftctl default
      ls -l etc/
      chown -R 1000:1000 etc/traefik
      ls -l etc/

  non-root-user:
    plugin: nil
    after: [default-config]
    overlay-script: |
      # Create a user in the $CRAFT_OVERLAY chroot
      useradd -R $CRAFT_OVERLAY -M -r -u 1000 -U traefik
